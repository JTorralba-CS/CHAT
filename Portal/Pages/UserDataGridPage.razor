@page "/userdatagrid"

@attribute [Authorize]

@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

@inject Services.LoginService LoginService

@implements IAsyncDisposable

<PageTitle>UserDataGrid</PageTitle>

@if (LoginService.Users == null)
{
    <p><em>Loading...</em></p>
}
else
{
    try
    {
        <RadzenDataGrid @ref=grid
        Data="@data"
        TItem="IDictionary<string, object>"
        AllowPaging="true"
        PageSize="12"
        PagerHorizontalAlign="HorizontalAlign.Center"
        AllowFiltering="true"
        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
        AllowSorting="true"
        IsLoading=@isLoading
        Page="@ShowLoading"
        Filter="@ShowLoading"
        Sort="@ShowLoading"
        Group="@ShowLoading"
        GridLines="Radzen.DataGridGridLines.Vertical"
        ColumnWidth="256px"
        AllowColumnResize="true"
        @bind-Settings="@settings">

            <Columns>
                @foreach (var column in columns)
                {
                    <RadzenDataGridColumn @key=@column.Key Title="@column.Key" Type="column.Value"
                    Property="@PropertyAccess.GetDynamicPropertyExpression(column.Key, column.Value)">
                        <Template>
                            @context[@column.Key]
                        </Template>
                    </RadzenDataGridColumn>
                }
            </Columns>

        </RadzenDataGrid>
    }
    catch (Exception e)
    {
        Log.Error($"Portal UserDataGrid.razor RadzenDataGrid() Exception: {e.Message}");
    }


}

@code {
    private RadzenDataGrid<IDictionary<string, object>> grid;

    private DataGridSettings settings
    {
        get
        {
            return _settings;
        }
        set
        {
            if (_settings != value)
            {
                _settings = value;
                InvokeAsync(SaveStateAsync);
            }
        }
    }

    private DataGridSettings _settings;

    private IDictionary<string, Type> columns { get; set; }

    private List<Dictionary<string, object>> cache = new List<Dictionary<string, object>>();

    private IEnumerable<IDictionary<string, object>> data;

    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        Log.ForContext("Folder", "Portal").Information($"Portal UserDataGrid.razor OnInitializedAsync()");

        columns = new Dictionary<string, Type>()
        {
            { "ID", typeof(long) },
            { "Name", typeof(string)},
            { "X", typeof(string)},
            { "Y", typeof(string)},
            { "Z", typeof(string)}
        };

        await ShowLoading();

        LoginService.OnChangeUsers += () =>
        {
            Update();

            if (data != null && data.Any())
            {
                try
                {
                    LoadStateAsync();

                    InvokeAsync(StateHasChanged);

                    InvokeAsync(grid.Reload);
                }
                catch (Exception e)
                {
                    Log.ForContext("Folder", "Portal").Error($"Portal UserDataGrid.razor OnChangeUsers() Exception: {e.Message}");
                }
            }
        };

        await LoginService.RequestUsers();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Log.ForContext("Folder", "Portal").Information($"Portal UserDataGrid.razor OnAfterRenderAsync() {firstRender}");

        try
        {
            if (firstRender)
            {
                Update();

                await LoadStateAsync();

                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception e)
        {
            Log.ForContext("Folder", "Portal").Error($"Portal UserDataGrid.razor OnAfterRenderAsync() Exception: {firstRender} {e.Message}");
        }
    }

    private async Task ShowLoading()
    {
        isLoading = true;

        await Task.Yield();

        isLoading = false;
    }

    private async Task LoadStateAsync()
    {
        string settings = await sessionStorage.GetItemAsync<string>("UserDataGrid");

        if (!string.IsNullOrEmpty(settings))
        {
            _settings = Newtonsoft.Json.JsonConvert.DeserializeObject<DataGridSettings>(settings);
        }
    }

    private async Task SaveStateAsync()
    {
        await sessionStorage.SetItemAsync("UserDataGrid", settings);
    }

    private async void Update()
    {
        cache.Clear();

        //List<User> SampleData = LoginService.Users.Select(user => new User {ID = user.ID, Name = user.Name, Password = user.Password}).Take(100000).ToList();

        foreach (User record in LoginService.Users)
        {
            Dictionary<string, object> recordDictionary = new Dictionary<string, object>();

            recordDictionary.Add("ID", (long) record.ID);
            recordDictionary.Add("Name", record.Name);
            recordDictionary.Add("X", Guid.NewGuid().ToString());
            recordDictionary.Add("Y", Guid.NewGuid().ToString());
            recordDictionary.Add("Z", Guid.NewGuid().ToString());

            cache.Add(recordDictionary);
        }

        data = cache;
    }

    public async ValueTask DisposeAsync()
    {
        LoginService.OnChangeUsers -= StateHasChanged;
    }
}
